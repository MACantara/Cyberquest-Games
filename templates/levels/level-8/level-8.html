{% extends "base.html" %}

{% block title %}Level 8: CivitasVote Security Audit{% endblock %}

{% block content %}
<!-- Highlight.js CSS and JS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/github-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/typescript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/jsx.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/solidity.min.js"></script>
<script type="text/javascript">
    // Initialize highlight.js when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        // Configure highlight.js with explicit language detection
        hljs.configure({
            languages: ['javascript', 'python', 'typescript', 'jsx', 'solidity']
        });
        hljs.highlightAll();
    });
</script>

<div class="min-h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-indigo-900 text-white">
    <!-- Security Audit Header -->
    <header class="border-b border-slate-700 bg-slate-800/50 backdrop-blur">
        <div class="px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 bg-green-600 rounded-lg flex items-center justify-center">
                        <i class="bi bi-shield-check text-white text-lg"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-green-400">CivitasVote Security Audit</h1>
                        <p class="text-sm text-slate-400">White Hat Penetration Testing - Phase 3</p>
                    </div>
                </div>
                <div class="flex items-center gap-6">
                    <div class="text-center">
                        <div class="text-lg font-bold text-green-400" id="integrity-score">100</div>
                        <div class="text-xs text-slate-400">Integrity</div>
                    </div>
                    <div class="text-center">
                        <div class="text-lg font-bold text-blue-400" id="vulnerabilities-found">0</div>
                        <div class="text-xs text-slate-400">Vulns Found</div>
                    </div>
                    <div class="text-center">
                        <div class="text-lg font-bold text-purple-400" id="ethical-score">100</div>
                        <div class="text-xs text-slate-400">Ethics Score</div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Audit Interface -->
    <div class="p-6">
        <!-- Top Status Section - Full Width -->
        <div class="grid grid-cols-2 gap-4 mb-6">
            <!-- Mission Status -->
            <div class="bg-slate-800/50 backdrop-blur border border-slate-700 rounded-xl p-4">
                <h4 class="text-slate-300 font-medium mb-3 text-sm">Mission Status</h4>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span class="text-slate-400">Phase:</span>
                        <span class="text-cyan-400" id="current-phase">Source Analysis</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-slate-400">Disclosure Decision:</span>
                        <span class="text-yellow-400" id="disclosure-status">Pending</span>
                    </div>
                </div>
                <button id="complete-audit" disabled class="w-full mt-4 bg-green-700 text-white px-4 py-2 rounded-lg opacity-50 cursor-not-allowed text-sm">
                    Complete Security Audit
                </button>
            </div>

            <!-- Audit Progress -->
            <div class="bg-slate-800/50 backdrop-blur border border-slate-700 rounded-xl p-4">
                <h4 class="text-white font-semibold mb-3">Audit Progress</h4>
                <div class="space-y-3">
                    <div class="flex justify-between text-sm">
                        <span class="text-slate-400">Files Analyzed:</span>
                        <span class="text-white" id="files-analyzed">0/4</span>
                    </div>
                    <div class="w-full bg-slate-700 rounded-full h-2">
                        <div id="progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <div class="grid grid-cols-3 gap-4 text-sm">
                        <div class="text-center">
                            <div class="text-orange-400" id="vuln-count">0 found</div>
                            <div class="text-slate-400 text-xs">Vulnerabilities</div>
                        </div>
                        <div class="text-center">
                            <div class="text-red-400" id="exploit-count">0</div>
                            <div class="text-slate-400 text-xs">Exploits Tested</div>
                        </div>
                        <div class="text-center">
                            <div class="text-yellow-400" id="risk-level">Unknown</div>
                            <div class="text-slate-400 text-xs">Risk Level</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="grid grid-cols-12 gap-4">
            
            <!-- Source Code & Analysis Panel - Now Full Width -->
            <div class="col-span-12 space-y-4">
                <!-- Code Repository Browser -->
                <div class="bg-slate-800/50 backdrop-blur rounded-xl border border-slate-700">
                    <div class="p-4 border-b border-slate-700">
                        <div class="flex items-center justify-between">
                            <div>
                                <h2 class="text-lg font-semibold text-white flex items-center gap-2">
                                    <i class="bi bi-code-slash text-cyan-400"></i>
                                    CivitasVote Source Code Repository
                                </h2>
                                <p class="text-sm text-slate-400 mt-1">Select files to analyze for security vulnerabilities</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- File Tree & Code Viewer -->
                    <div class="p-4">
                        <div class="grid grid-cols-3 gap-4">
                            <!-- File Tree -->
                            <div class="bg-slate-900/50 rounded-lg p-3">
                                <h4 class="text-white font-medium mb-3 text-sm">Project Files</h4>
                                <div class="space-y-1 text-sm">
                                    <div class="code-file cursor-pointer hover:bg-slate-700/50 p-2 rounded text-slate-300 hover:text-white" data-file="vote-processor">
                                        <i class="bi bi-file-earmark-code text-red-400 mr-2"></i>
                                        vote-processor.js
                                        <span class="text-xs text-red-400 ml-2">CRITICAL</span>
                                    </div>
                                    <div class="code-file cursor-pointer hover:bg-slate-700/50 p-2 rounded text-slate-300 hover:text-white" data-file="auth-handler">
                                        <i class="bi bi-file-earmark-code text-orange-400 mr-2"></i>
                                        auth-handler.py
                                        <span class="text-xs text-orange-400 ml-2">HIGH</span>
                                    </div>
                                    <div class="code-file cursor-pointer hover:bg-slate-700/50 p-2 rounded text-slate-300 hover:text-white" data-file="blockchain-api">
                                        <i class="bi bi-file-earmark-code text-yellow-400 mr-2"></i>
                                        blockchain-api.sol
                                        <span class="text-xs text-yellow-400 ml-2">MEDIUM</span>
                                    </div>
                                    <div class="code-file cursor-pointer hover:bg-slate-700/50 p-2 rounded text-slate-300 hover:text-white" data-file="frontend-ui">
                                        <i class="bi bi-file-earmark-code text-blue-400 mr-2"></i>
                                        voting-ui.tsx
                                        <span class="text-xs text-blue-400 ml-2">LOW</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Code Viewer -->
                            <div class="col-span-2 bg-slate-900/50 rounded-lg p-3">
                                <div class="flex items-center justify-between mb-3">
                                    <h4 id="current-file" class="text-white font-medium text-sm">Select a file to analyze</h4>
                                    <div class="flex gap-2">
                                        <button id="analyze-code" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs" disabled>
                                            <i class="bi bi-search mr-1"></i>
                                            Analyze
                                        </button>
                                        <button id="find-vulns" class="bg-orange-600 hover:bg-orange-700 text-white px-3 py-1 rounded text-xs" disabled>
                                            <i class="bi bi-bug mr-1"></i>
                                            Find Vulns
                                        </button>
                                    </div>
                                </div>
                                <div id="code-content" class="bg-black/50 rounded p-3 min-h-48 font-mono text-xs text-green-400 overflow-auto">
                                    <div class="text-slate-400 text-center mt-8">
                                        Click on a file to view its source code
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Vulnerability Analysis Results -->
                <div id="vulnerability-panel" class="bg-slate-800/50 backdrop-blur rounded-xl border border-slate-700 p-4 hidden">
                    <h3 class="text-lg font-semibold text-red-400 mb-4 flex items-center gap-2">
                        <i class="bi bi-exclamation-triangle"></i>
                        Vulnerability Analysis Results
                    </h3>
                    <div id="vulnerability-list" class="space-y-3">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <!-- Exploit Testing Environment -->
                <div id="exploit-panel" class="bg-slate-800/50 backdrop-blur rounded-xl border border-slate-700 p-4 hidden">
                    <h3 class="text-lg font-semibold text-orange-400 mb-4 flex items-center gap-2">
                        <i class="bi bi-terminal"></i>
                        Exploit Testing Environment
                    </h3>
                    <div class="bg-black/50 rounded-lg p-4">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="text-green-400">root@pentest:~#</span>
                            <input type="text" id="exploit-command" class="bg-transparent text-white flex-1 outline-none font-mono" 
                                   placeholder="Enter exploit command..." disabled>
                            <button id="run-exploit" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm" disabled>
                                Execute
                            </button>
                        </div>
                        <div id="exploit-output" class="text-green-400 font-mono text-sm min-h-24">
                            <!-- Exploit results shown here -->
                        </div>
                    </div>
                    <div class="mt-4 p-3 bg-yellow-900/30 border border-yellow-600 rounded-lg">
                        <div class="flex items-start gap-2">
                            <i class="bi bi-exclamation-triangle text-yellow-400 mt-1"></i>
                            <div>
                                <h5 class="text-yellow-300 font-medium">Ethical Testing Warning</h5>
                                <p class="text-yellow-200 text-sm">You are conducting authorized penetration testing. All activities are logged and monitored.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Disclosure Decision Panel -->
                <div id="disclosure-panel" class="bg-slate-800/50 backdrop-blur rounded-xl border border-slate-700 p-6 hidden">
                    <h3 class="text-lg font-semibold text-yellow-400 mb-4 flex items-center gap-2">
                        ⚖️ Critical Decision: Vulnerability Disclosure
                    </h3>
                    
                    <div class="bg-red-900/30 border border-red-600 rounded-lg p-4 mb-6">
                        <h4 class="text-red-300 font-semibold mb-2">Critical Vulnerability Confirmed</h4>
                        <p class="text-red-200 text-sm mb-3">
                            You've discovered a severe authentication bypass that allows vote manipulation. 
                            This could compromise the entire election. How do you proceed?
                        </p>
                        <div class="text-red-300 text-sm">
                            <strong>Impact:</strong> Complete election integrity compromise<br>
                            <strong>Exploitability:</strong> High (Remote, no authentication required)<br>
                            <strong>Discovery:</strong> You are the first to find this vulnerability
                        </div>
                    </div>

                    <div class="space-y-3">
                        <button class="disclosure-option w-full text-left p-4 border border-green-600 bg-green-900/20 hover:bg-green-900/40 rounded-lg transition-all" data-choice="responsible">
                            <div class="flex items-start gap-3">
                                <i class="bi bi-shield-check text-green-400 text-xl mt-1"></i>
                                <div>
                                    <h5 class="text-green-300 font-semibold">Responsible Disclosure</h5>
                                    <p class="text-green-200 text-sm mt-1">Report directly to CivitasVote security team with 90-day disclosure timeline</p>
                                    <div class="text-xs text-green-400 mt-2">✓ Ethical ✓ Legal ✓ Protects democracy</div>
                                </div>
                            </div>
                        </button>

                        <button class="disclosure-option w-full text-left p-4 border border-blue-600 bg-blue-900/20 hover:bg-blue-900/40 rounded-lg transition-all" data-choice="public">
                            <div class="flex items-start gap-3">
                                <i class="bi bi-megaphone text-blue-400 text-xl mt-1"></i>
                                <div>
                                    <h5 class="text-blue-300 font-semibold">Public Disclosure</h5>
                                    <p class="text-blue-200 text-sm mt-1">Immediately publish findings to security communities and media</p>
                                    <div class="text-xs text-blue-400 mt-2">⚠ High impact ⚠ May cause panic ⚠ Forces immediate action</div>
                                </div>
                            </div>
                        </button>

                        <button class="disclosure-option w-full text-left p-4 border border-red-600 bg-red-900/20 hover:bg-red-900/40 rounded-lg transition-all" data-choice="blackmarket">
                            <div class="flex items-start gap-3">
                                <i class="bi bi-currency-bitcoin text-red-400 text-xl mt-1"></i>
                                <div>
                                    <h5 class="text-red-300 font-semibold">Black Market Sale</h5>
                                    <p class="text-red-200 text-sm mt-1">Sell vulnerability information to highest bidder on dark web</p>
                                    <div class="text-xs text-red-400 mt-2">✗ Illegal ✗ Unethical ✗ Threatens democracy</div>
                                </div>
                            </div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Opening Cutscene Modal -->
    <div id="cutscene-modal" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50">
        <div class="bg-slate-800 rounded-xl p-8 max-w-2xl mx-4 border border-slate-600">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-green-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="bi bi-shield-check text-white text-2xl"></i>
                </div>
                <h2 class="text-2xl font-bold text-white mb-2">Ethics Lab - CivitasVote Security Audit</h2>
                <p class="text-lg text-green-400 font-semibold">WHITE HAT ASSIGNMENT</p>
            </div>
            
            <div class="space-y-4 text-slate-300">
                <p>You've been assigned to perform ethical penetration testing on CivitasVote, a blockchain-based voting system preparing for deployment.</p>
                
                <div class="bg-red-900/30 border border-red-600 rounded-lg p-4">
                    <h3 class="font-semibold text-red-300 mb-2">CRITICAL DISCOVERY</h3>
                    <p class="text-red-200">Early tests reveal a major flaw: votes can be intercepted and altered before finalization. Your integrity will be tested.</p>
                </div>
                
                <div class="bg-blue-900/30 border border-blue-600 rounded-lg p-4">
                    <div class="flex items-start gap-3">
                        <i class="bi bi-robot text-blue-400 text-lg mt-1"></i>
                        <div>
                            <h3 class="font-semibold text-blue-300 mb-1">Mentor AI - Argus</h3>
                            <p class="text-blue-200 text-sm">"Nova, ethical hacking isn't just about finding vulnerabilities—it's about doing the right thing with that knowledge. Your choices here define who you are."</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="text-center mt-6">
                <button id="start-mission" class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-lg font-semibold">
                    Begin Security Audit
                </button>
            </div>
        </div>
    </div>

    <!-- Results Modal -->
    <div id="results-modal" class="hidden fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50">
        <div class="bg-slate-800 rounded-xl p-6 max-w-lg mx-4 border border-slate-600">
            <div class="text-center mb-4">
                <div id="result-icon" class="text-4xl mb-2">⚖️</div>
                <h3 id="result-title" class="text-xl font-bold text-white mb-2">Ethical Decision</h3>
                <p id="result-message" class="text-slate-300"></p>
            </div>
            <div id="result-feedback" class="mb-4">
                <!-- Feedback content -->
            </div>
            <div class="text-center">
                <button id="continue-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg">
                    Continue
                </button>
            </div>
        </div>
    </div>
</div>

<script type="module" src="/static/js/levels/level-8/level-8.js"></script>
{% endblock %}